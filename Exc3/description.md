**Анализ текущей архитектуры и проблемы с ростом нагрузки**

### Список проблем и рисков

#### 1. Зависимость от синхронных REST API запросов
- Сервис core-app запрашивает данные у ins-product-aggregator раз в 15 минут для обновления локальной базы данных.
- Сервис ins-comp-settlement осуществляет аналогичные запросы раз в сутки.
- Это приводит к дополнительной нагрузке на ins-product-aggregator, особенно с ростом числа подключенных страховых компаний (ещё 5 в ближайшее время).
- Высокая уязвимость к задержкам и ошибкам в API страховых компаний.

#### 2. Проблемы с масштабированием
- Планируемое увеличение числа подключённых страховых компаний повысит нагрузку на ins-product-aggregator и общую скорость обработки запросов.
- Синхронные REST API запросы позволяют одновременному клиенту занимать все ресурсы, что может привести к повторным сбоям SLA.

#### 3. Отсутствие событий для реального времени
- Актуальность данных о страховых продуктах обновляется лишь раз в 15 минут или раз в сутки.
- Высокий риск неактуальности данных, что подрывает доверие к сервису.

#### 4. Отсутствие оперативного мониторинга и алертов
- Задержка обнаружения проблем непосредственно влияет на бизнес, увеличивая время простоя.

### Решения и переход на Event-Driven архитектуру

1. **Использование брокера сообщений**
   - Использовать брокер сообщений Apache Kafka, который поддерживает высокую пропускную способность и гарантированную доставку.
   - Развернуть брокер в существующем Kubernetes-кластере, настроить репликацию для обеспечения отказоустойчивости.

2. **Перенос взаимодействий на событийную модель**
   - Определить основные события: обновление данных о продуктах, оформление страховки, завершение расчетов.
   - Реализовать публикацию событий в ins-product-aggregator при изменениях данных страховых компаний.
   - Разработать подписчики в core-app и ins-comp-settlement для обработки обновлений в реальном времени.

3. **Кэширование данных**
   - Внедрить временной кэш (например, Redis) в core-app и ins-comp-settlement для хранения часто запрашиваемых данных о продуктах.
   - Настроить автоматическую очистку кэша на основе событий обновления.

4. **Оптимизация процесса формирования реестров**
   - Перенести логику формирования реестров из core-app в ins-comp-settlement, используя события для передачи данных.
   - В ins-comp-settlement реализовать сбор данных за день из временного хранилища событий, минимизируя зависимости от core-app.

5. **Мониторинг и алерты**
   - Настроить мониторинг брокера сообщений и подписчиков (например, используя Prometheus и Grafana).
   - Разработать алерты на случаи задержек или сбойных сообщений, чтобы оперативно реагировать на проблемы.

6. **Обновление контрактов API**
   - Заменить REST-запросы на механизмы подписки и публикации событий для всех взаимодействий между core-app, ins-product-aggregator и ins-comp-settlement.
   - Временная поддержка гибридной модели (REST + события) для плавного перехода и минимизации рисков.
1. Переход на асинхронную обработку событий, используя мессдж-брокер Apache Kafka.
   - Это решение позволит сервисам core-app и ins-comp-settlement получать обновления данных практически в реальном времени, устранив задержки, характерные для синхронных REST-запросов.
   - Брокер сообщений обеспечит масштабируемость, высокую пропускную способность и возможность обработки всплесков нагрузки.
   - Использование событий снижает зависимость от точек отказа в системе, так как данные передаются через надёжный промежуточный слой.
2. Введение событий для обновлений продуктов, выгрузки данных из core-app в ins-comp-settlement.
3. Временной кэш или стораж для ускорения чтения и повышения стабильности.

